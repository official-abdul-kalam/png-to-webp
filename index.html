<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNG → WebP Compressor (Crop + Rename)</title>
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
  <style>
    :root {
      font-family: 'Inter', system-ui, sans-serif;
      --bg-dark: #0e1624;
      --bg-card: #101b2e;
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --text: #e8eef8;
      --text-muted: #9aaec9;
    }
    * { box-sizing: border-box; }
    body {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0; padding: 20px;
      background: var(--bg-dark); color: var(--text);
    }
    .card {
      width: 900px; max-width: 100%; background: var(--bg-card);
      border-radius: 16px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }
    h1 { text-align:center; font-size:22px; margin-bottom:6px; }
    p.lead { text-align:center; margin:0 0 16px; color:var(--text-muted); font-size:14px; }
    .drop {
      border:2px dashed rgba(255,255,255,0.07);
      border-radius:12px; padding:26px; text-align:center;
      transition:all .3s ease; background:rgba(255,255,255,0.02);
    }
    .drop.dragover { border-color:var(--accent); background:rgba(59,130,246,0.1); }
    .btn {
      background:var(--accent); color:white; border:none; border-radius:8px;
      padding:8px 14px; cursor:pointer; font-size:14px;
      transition:background .25s ease, transform .2s ease;
    }
    .btn:hover { background:var(--accent-light); transform:translateY(-1px); }
    .btn-secondary { background:#475569; }
    .btn-small { font-size:13px; padding:6px 10px; }
    table { width:100%; border-collapse:collapse; font-size:13px; margin-top:16px; }
    th,td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:left; }
    footer { margin-top:14px; font-size:12px; color:var(--text-muted); text-align:center; }

    .actions a.link {
      display:inline-block; background:rgba(59,130,246,0.1);
      padding:5px 10px; border-radius:6px; margin-right:8px;
      text-decoration:none; color:var(--accent-light);
    }
    .actions a.link:hover { background:var(--accent-light); color:#fff; }

    /* Cropper Modal */
    #cropperModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); justify-content:center; align-items:center; flex-direction:column; z-index:1000;
    }
    #cropperModal img { max-width:80%; max-height:70%; border-radius:8px; }
    .modal-controls {
      margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
    }
    input.rename {
      background:#111a28; border:1px solid #222; color:#fff;
      border-radius:6px; padding:6px 10px; outline:none;
      width:200px; font-size:14px;
    }
    @media (max-width:600px){
      .card{padding:16px;}
      table,th,td{font-size:12px;}
      #cropperModal img { max-width:95%; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>PNG → WebP Compressor</h1>
    <p class="lead">Crop (4:5), rename optional, and convert to WebP (quality=70). All client-side, no upload.</p>

    <div id="drop" class="drop">
      <p><strong>Drop PNG files here</strong></p>
      <input id="fileInput" type="file" accept="image/png,image/*" multiple />
      <button id="clearBtn" class="btn btn-secondary">Clear</button>
    </div>

    <table id="table" style="display:none;">
      <thead><tr><th>Original</th><th>Original size</th><th>Converted</th><th>Converted size</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <footer>Offline, fast & secure — now with crop + rename option ✨</footer>
  </div>

  <!-- Cropper Modal -->
  <div id="cropperModal">
    <img id="cropImage" />
    <div class="modal-controls">
      <input id="renameInput" class="rename" placeholder="optional-name" pattern="[a-z0-9\-]+" />
      <button id="startCrop" class="btn btn-small">Start Compression</button>
      <button id="cancelCrop" class="btn btn-secondary btn-small">Cancel</button>
    </div>
  </div>

  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const table = document.getElementById('table');
    const tbody = table.querySelector('tbody');
    const clearBtn = document.getElementById('clearBtn');
    const cropperModal = document.getElementById('cropperModal');
    const cropImage = document.getElementById('cropImage');
    const renameInput = document.getElementById('renameInput');
    const startCrop = document.getElementById('startCrop');
    const cancelCrop = document.getElementById('cancelCrop');
    let cropper, currentFile;

    function human(size){
      if(size < 1024) return size.toFixed(0)+' B';
      if(size < 1024*1024) return (size/1024).toFixed(1)+' KB';
      return (size/(1024*1024)).toFixed(2)+' MB';
    }

    function readFileAsDataURL(file){
      return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});
    }

    function openCropper(file){
      currentFile = file;
      readFileAsDataURL(file).then(data=>{
        cropImage.src = data;
        cropperModal.style.display='flex';
        cropper = new Cropper(cropImage, {
          aspectRatio: 4/5,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
        });
      });
    }

    startCrop.onclick = async ()=>{
      const canvas = cropper.getCroppedCanvas();
      const blob = await new Promise(res=>canvas.toBlob(res,'image/webp',0.7));
      const rename = renameInput.value.trim();
      const safeName = rename ? rename.replace(/[^a-z0-9\-]/g,'') : currentFile.name.replace(/\.[^.]+$/, '');
      const outName = safeName+'.webp';
      cropper.destroy();
      cropperModal.style.display='none';
      renameInput.value='';
      showResult(currentFile, blob, outName);
    };

    cancelCrop.onclick = ()=>{
      cropper.destroy();
      cropperModal.style.display='none';
    };

    function showResult(originalFile, blob, outName){
      table.style.display='block';
      const url = URL.createObjectURL(blob);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${originalFile.name}</td>
        <td>${human(originalFile.size)}</td>
        <td>${outName}</td>
        <td>${human(blob.size)}</td>
        <td class="actions">
          <a class="link" href="${url}" download="${outName}">Download</a>
          <a class="link" href="${url}" target="_blank">Preview</a>
        </td>`;
      tbody.appendChild(row);
    }

    function handleFiles(files){
      const arr = Array.from(files).filter(f=>f.type.startsWith('image/'));
      if(!arr.length) return alert('Please select image files');
      openCropper(arr[0]); // one-by-one crop process
    }

    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('dragover');}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('dragover');}));
    drop.addEventListener('drop',e=>{if(e.dataTransfer.files)handleFiles(e.dataTransfer.files);});
    fileInput.addEventListener('change',e=>{if(e.target.files)handleFiles(e.target.files);});
    clearBtn.addEventListener('click',()=>{tbody.innerHTML='';table.style.display='none';fileInput.value='';});
  </script>
</body>
</html>
